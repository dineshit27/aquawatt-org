import{c as ce,r as y,i as fe,h as he,k as ge,s as pe,j as e,C as A,a as C,b as U,d as S,B as M,t as F}from"./index-pyDnZmym.js";import{a as re}from"./DashboardHeader-PAEKF7nm.js";import{R as Ne}from"./refresh-cw-Dtlj4at3.js";import{C as je}from"./chart-column-BAWIJJJJ.js";import{T as ne}from"./trending-up-CAxTgZiE.js";import{T as ie}from"./trending-down-enRbLAb9.js";import"./label-D7uTkZ5E.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const L=ce("Download",[["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["polyline",{points:"7 10 12 15 17 10",key:"2ggqvy"}],["line",{x1:"12",x2:"12",y1:"15",y2:"3",key:"1vk2je"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const oe=ce("FileText",[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["path",{d:"M10 9H8",key:"b1mrlr"}],["path",{d:"M16 13H8",key:"t4e002"}],["path",{d:"M16 17H8",key:"z1uh3a"}]]),Ae=()=>{var V,K,Z,J,ee,te,se,ae,le;const[a,O]=y.useState(null),[N,P]=y.useState([]),[T,k]=y.useState(!0),[b,W]=y.useState(null),[H,X]=y.useState(null),{user:v,loading:q}=fe(),G=new Date,Q=G.toLocaleString("default",{month:"long"}),E=G.getFullYear(),I=y.useCallback(async l=>{k(!0),W(null);try{const t=l;if(!t){X(null);const o=new Date,i=[];for(let f=0;f<6;f++){const h=new Date(Date.UTC(o.getUTCFullYear(),o.getUTCMonth()-f,1)),p=1400+Math.round(Math.random()*900);i.push({id:`demo-${f}`,period_start:h.toISOString(),period_end:new Date(Date.UTC(h.getUTCFullYear(),h.getUTCMonth()+1,0)).toISOString(),water_usage:0,electricity_usage:0,water_cost:0,electricity_cost:0,total_amount:p,status:"demo",due_date:new Date(Date.UTC(h.getUTCFullYear(),h.getUTCMonth()+1,10)).toISOString(),paid_at:null})}O(i[0]),P(i),k(!1);return}X(t);const[g,d]=await Promise.all([he(),ge(12)]);let n=g,r=d;const j=(r||[]).reduce((o,i)=>o+(Number((i==null?void 0:i.total_amount)||0)||0),0);if(!n&&(!r||r.length===0)||j<=0)try{const o=new Date,i=new Date(Date.UTC(o.getUTCFullYear()-1,0,1)),f=u=>u.toISOString(),{data:h,error:p}=await pe.from("billing_line_items").select("cost, occurred_at, user_id").eq("user_id",t).gte("occurred_at",f(i)).lte("occurred_at",f(o));p&&console.warn("line_items fallback error",p);const D=new Map;(h||[]).forEach(u=>{const c=new Date(u.occurred_at),m=`${c.getUTCFullYear()}-${String(c.getUTCMonth()+1).padStart(2,"0")}`,w=new Date(Date.UTC(c.getUTCFullYear(),c.getUTCMonth(),1)),$=D.get(m),xe=(Number((u==null?void 0:u.cost)??0)||0)+(($==null?void 0:$.amount)||0);D.set(m,{amount:xe,start:w})});const Y=Array.from(D.values()).sort((u,c)=>c.start.getTime()-u.start.getTime()).slice(0,13).map((u,c)=>({id:`synthetic-${c}`,period_start:u.start.toISOString(),period_end:new Date(Date.UTC(u.start.getUTCFullYear(),u.start.getUTCMonth()+1,0)).toISOString(),water_usage:0,electricity_usage:0,water_cost:0,electricity_cost:0,total_amount:u.amount,status:"computed",due_date:new Date(Date.UTC(u.start.getUTCFullYear(),u.start.getUTCMonth()+1,10)).toISOString(),paid_at:null}));Y.length&&(n=Y[0],r=Y)}catch(o){console.warn("billing fallback failed",o)}const _=(r||[]).reduce((o,i)=>o+(Number((i==null?void 0:i.total_amount)||0)||0),0);if(!n||!r||r.length===0||_<=0){const o=new Date,i=[];for(let f=0;f<6;f++){const h=new Date(Date.UTC(o.getUTCFullYear(),o.getUTCMonth()-f,1)),p=1200+Math.round(Math.random()*800);i.push({id:`demo-${f}`,period_start:h.toISOString(),period_end:new Date(Date.UTC(h.getUTCFullYear(),h.getUTCMonth()+1,0)).toISOString(),water_usage:0,electricity_usage:0,water_cost:0,electricity_cost:0,total_amount:p,status:"demo",due_date:new Date(Date.UTC(h.getUTCFullYear(),h.getUTCMonth()+1,10)).toISOString(),paid_at:null})}n=i[0],r=i}O(n),P(r)}catch(t){W(t.message||"Failed to load billing")}finally{k(!1)}},[]);y.useEffect(()=>{q||I((v==null?void 0:v.id)||void 0)},[q,v==null?void 0:v.id,I]);const s=y.useMemo(()=>{if(!N.length)return{ytdTotal:0,ytdAvg:0,prevYearYtdTotal:0,yearlyDiffAmount:0,yearlyDiffPct:"0.0",savings:0,diffAmount:0,diffPct:"0.0"};const l=new Date,t=l.getFullYear(),g=l.getMonth(),d=a||N[0],n=N.filter(c=>{const m=new Date(c.period_start);return m.getFullYear()===t&&m.getMonth()<=g}),r=n.reduce((c,m)=>c+Number(m.total_amount||0),0),j=n.length?r/n.length:0,_=t-1,i=N.filter(c=>{const m=new Date(c.period_start);return m.getFullYear()===_&&m.getMonth()<=g}).reduce((c,m)=>c+Number(m.total_amount||0),0),f=r-i,h=i?(f/i*100).toFixed(1):"0.0",p=N.find(c=>{if(!d)return!1;const m=new Date(d.period_start),w=new Date(c.period_start);return w.getFullYear()===m.getFullYear()&&w.getMonth()===m.getMonth()-1}),D=p?Number((d==null?void 0:d.total_amount)||0)-Number(p.total_amount||0):0,Y=p&&p.total_amount?(D/p.total_amount*100).toFixed(1):"0.0",u=N.find(c=>{const m=new Date(c.period_start);if(!d)return!1;const w=new Date(d.period_start);return m.getFullYear()===w.getFullYear()-1&&m.getMonth()===w.getMonth()});return{current:d,previous:p,ytdTotal:r,ytdAvg:j,prevYearYtdTotal:i,yearlyDiffAmount:f,yearlyDiffPct:h,sameMonthLastYear:u,savings:0,diffAmount:D,diffPct:Y}},[N,a]),z=83,x=l=>{if(!l)return"₹0.00";try{const t=l*z;return new Intl.NumberFormat("en-IN",{style:"currency",currency:"INR",minimumFractionDigits:2}).format(t)}catch{return"₹"+(l*z).toFixed(2)}},de=()=>{const l=document.createElement("canvas");l.width=800,l.height=1200;const t=l.getContext("2d");t.fillStyle="#ffffff",t.fillRect(0,0,800,1200),t.fillStyle="#2c3e50",t.fillRect(0,0,800,120),t.fillStyle="white",t.font="bold 32px Arial",t.textAlign="center",t.fillText("AQUAWATT | USAGE DOCUMENT",400,75),t.fillStyle="#000",t.font="bold 18px Arial",t.textAlign="left",t.fillText("G. MOORTHY",60,170),t.font="14px Arial",t.fillText("AquaWatt id:",60,200),t.fillText("AW12XX",180,200),t.fillText("Date Issued:",60,225),t.fillText("Aug 07, 2025",180,225),t.fillText("Invoice No:",60,250),t.fillText("012XX",180,250),t.font="bold 16px Arial",t.fillText("DESCRIPTION",60,300),t.textAlign="center",t.fillText("CURRENT",350,300),t.fillText("PREVIOUS",500,300),t.fillText("AVERAGE",650,300),t.strokeStyle="#000",t.lineWidth=2,t.beginPath(),t.moveTo(60,310),t.lineTo(740,310),t.stroke();const g=[["Water Usage",a?`${Number(a.water_usage||0).toFixed(2)} L`:"-",s.previous?`${Number(s.previous.water_usage||0).toFixed(2)} L`:"-","—"],["Electricity Usage",a?`${Number(a.electricity_usage||0).toFixed(2)} kWh`:"-",s.previous?`${Number(s.previous.electricity_usage||0).toFixed(2)} kWh`:"-","—"],["Water Cost",a?`${x(Number(a.water_cost||0))}`:"-",s.previous?`${x(Number(s.previous.water_cost||0))}`:"-","—"],["Electricity Cost",a?`${x(Number(a.electricity_cost||0))}`:"-",s.previous?`${x(Number(s.previous.electricity_cost||0))}`:"-","—"]];t.font="14px Arial",t.textAlign="left",g.forEach((j,_)=>{const o=340+_*35;_%2===0&&(t.fillStyle="#e8e6ff",t.fillRect(60,o-20,680,35)),t.fillStyle="#000",t.fillText(j[0],70,o),t.textAlign="center",t.fillText(j[1],350,o),t.fillText(j[2],500,o),t.fillText(j[3],650,o),t.textAlign="left"});const d=580;t.font="bold 16px Arial",t.textAlign="right",t.fillText("ELECTRICITY USAGE",600,d),t.fillText("WATER USAGE",600,d+30),t.textAlign="left",t.fillText(a?`${Number(a.electricity_usage||0).toFixed(0)} kWh`:"-",650,d),t.fillText(a?`${Number(a.water_usage||0).toFixed(0)} L`:"-",650,d+30);const n=680;t.fillStyle="#f8f9fa",t.fillRect(0,n,800,120),t.fillStyle="#000",t.font="bold 14px Arial",t.fillText("CLIENT AQUAWATT INFO",60,n+30),t.fillText("ANALYSED AT",500,n+30),t.font="14px Arial",t.fillText("G. MOORTHY",60,n+55),t.fillText("Account No: 0123 4567 8XXX",60,n+75),t.fillText("Short Code: 0123XXX",60,n+95),t.font="bold 18px Arial",t.fillText("Aug 17, 2025",500,n+55),t.font="12px Arial",t.fillText("THANK YOU",60,n+110),t.textAlign="right",t.fillText("AQUAWATT - ORG",740,n+110);const r=1120;return t.fillStyle="#2c3e50",t.fillRect(0,r,800,80),t.fillStyle="white",t.font="14px Arial",t.textAlign="center",t.fillText("📧 enquiry@aquawatt.com",200,r+45),t.fillText("📞 +123-456-7890",400,r+45),t.fillText("🌐 AquaWatt.com",600,r+45),l},R=async l=>{try{const t=de();return new Promise(g=>{t.toBlob(d=>{if(!d){g(!1);return}const n=URL.createObjectURL(d),r=document.createElement("a");r.href=n,r.download=l,document.body.appendChild(r),r.click(),r.remove(),URL.revokeObjectURL(n),g(!0)},"image/jpeg",.9)})}catch(t){return console.error("Download failed:",t),!1}},B=async l=>{try{const t=`AQUAWATT-Usage-Document-${l.replace(/\s/g,"-")}.jpg`;if(await R(t))F({title:"Document Downloaded",description:`Your ${l} usage document has been downloaded`});else throw new Error("Download failed")}catch(t){console.error("Download error:",t),F({title:"Download Failed",description:"There was an error downloading the document. Please try again.",variant:"destructive"})}},me=async()=>{try{if(await R("AQUAWATT-Usage-Report.jpg"))F({title:"Export Complete",description:"Usage report has been downloaded"});else throw new Error("Export failed")}catch(l){console.error("Export error:",l),F({title:"Export Failed",description:"There was an error exporting the report. Please try again.",variant:"destructive"})}},ue=async()=>{try{if(await R("AQUAWATT-Detailed-Usage-Report.jpg"))F({title:"Export Complete",description:"Detailed usage report downloaded successfully."});else throw new Error("Export failed")}catch(l){console.error("Detailed export error:",l),F({title:"Export Failed",description:"Could not export the report. Please try again.",variant:"destructive"})}};return!H&&!T?e.jsx("div",{className:"min-h-screen bg-background flex flex-col",children:e.jsxs("main",{className:"flex-1 flex flex-col w-full md:w-auto",children:[e.jsx(re,{}),e.jsx("div",{className:"flex-1 p-6",children:"Please sign in to view billing."})]})}):e.jsx("div",{className:"min-h-screen bg-background flex flex-col",children:e.jsxs("main",{className:"flex-1 flex flex-col w-full md:w-auto",children:[e.jsx(re,{}),e.jsx("div",{className:"flex-1 p-6",children:e.jsxs("div",{className:"grid gap-6",children:[T&&e.jsxs(A,{children:[e.jsx(C,{children:e.jsx(U,{children:"Loading Billing Data…"})}),e.jsx(S,{className:"text-sm text-muted-foreground",children:"Fetching latest billing records."})]}),b&&!T&&e.jsxs(A,{children:[e.jsxs(C,{className:"flex flex-row items-center justify-between",children:[e.jsx(U,{className:"text-red-600",children:"Billing Error"}),e.jsx(M,{variant:"ghost",size:"sm",onClick:()=>I(H||void 0),children:e.jsx(Ne,{className:"h-4 w-4"})})]}),e.jsx(S,{className:"text-sm",children:b})]}),!T&&!b&&e.jsxs(A,{children:[e.jsx(C,{children:e.jsxs(U,{className:"flex items-center gap-2",children:[e.jsx(je,{className:"h-5 w-5"}),"Monthly Summary & Insights"]})}),e.jsxs(S,{children:[e.jsxs("div",{className:"grid md:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"This Month vs Last Month"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-2xl font-bold",children:x(Number(((V=s.current)==null?void 0:V.total_amount)||0))}),e.jsxs("div",{className:`flex items-center gap-1 text-sm ${s.diffAmount>0?"text-red-500":"text-green-500"}`,children:[s.diffAmount>0?e.jsx(ne,{className:"h-4 w-4"}):e.jsx(ie,{className:"h-4 w-4"}),s.diffPct,"%"]})]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[s.diffAmount>0?`${x(s.diffAmount)} more`:`${x(Math.abs(s.diffAmount))} less`," than last month"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Average Monthly Cost"}),e.jsx("span",{className:"text-2xl font-bold",children:x(s.ytdAvg)}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Year to date average"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Total Savings"}),e.jsx("span",{className:"text-2xl font-bold text-green-500",children:"₹0.00"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"(Placeholder)"})]})]}),e.jsxs("div",{className:"mt-8 grid gap-4 md:grid-cols-3",children:[e.jsxs("div",{className:"p-4 rounded-lg border bg-muted/30",children:[e.jsxs("p",{className:"text-xs text-muted-foreground mb-1",children:["YTD Total (",E,")"]}),e.jsx("p",{className:"text-lg font-semibold",children:x(s.ytdTotal)})]}),e.jsxs("div",{className:"p-4 rounded-lg border bg-muted/30",children:[e.jsxs("p",{className:"text-xs text-muted-foreground mb-1",children:["YTD Total (",E-1,")"]}),e.jsx("p",{className:"text-lg font-semibold",children:x(s.prevYearYtdTotal)})]}),e.jsxs("div",{className:"p-4 rounded-lg border bg-muted/30",children:[e.jsx("p",{className:"text-xs text-muted-foreground mb-1",children:"Change vs Last Year"}),e.jsxs("div",{className:`flex items-center gap-2 ${s.yearlyDiffAmount>0?"text-red-600":"text-green-600"}`,children:[s.yearlyDiffAmount>0?e.jsx(ne,{className:"h-4 w-4"}):e.jsx(ie,{className:"h-4 w-4"}),e.jsxs("span",{className:"font-semibold",children:[x(Math.abs(s.yearlyDiffAmount))," (",s.yearlyDiffPct,"%)"]})]})]})]}),s.sameMonthLastYear&&e.jsxs("div",{className:"mt-4 text-xs text-muted-foreground",children:["Same month last year: ",x(Number(s.sameMonthLastYear.total_amount||0))]}),e.jsxs("div",{className:"mt-6 grid md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"p-4 bg-muted/50 rounded-lg",children:[e.jsx("h4",{className:"font-medium mb-2",children:"Water Usage Trend"}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{children:["Current: ",(Number(((K=s.current)==null?void 0:K.water_usage)||0)/1e3).toFixed(2)," kL"]}),e.jsxs("span",{className:"text-muted-foreground",children:["Previous: ",(Number(((Z=s.previous)==null?void 0:Z.water_usage)||0)/1e3).toFixed(2)," kL"]})]}),e.jsx("div",{className:"text-xs text-muted-foreground",children:Number(((J=s.current)==null?void 0:J.water_usage)||0)>Number(((ee=s.previous)==null?void 0:ee.water_usage)||0)?"Usage increased":"Usage decreased"})]})]}),e.jsxs("div",{className:"p-4 bg-muted/50 rounded-lg",children:[e.jsx("h4",{className:"font-medium mb-2",children:"Electricity Usage Trend"}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{children:["Current: ",Number(((te=s.current)==null?void 0:te.electricity_usage)||0).toFixed(0)," kWh"]}),e.jsxs("span",{className:"text-muted-foreground",children:["Previous: ",Number(((se=s.previous)==null?void 0:se.electricity_usage)||0).toFixed(0)," kWh"]})]}),e.jsx("div",{className:"text-xs text-muted-foreground",children:Number(((ae=s.current)==null?void 0:ae.electricity_usage)||0)>Number(((le=s.previous)==null?void 0:le.electricity_usage)||0)?"Usage increased":"Usage decreased"})]})]})]})]})]}),!T&&!b&&e.jsxs(A,{id:"export",className:"scroll-mt-24",children:[e.jsx(C,{children:e.jsxs(U,{className:"flex items-center gap-2",children:[e.jsx(oe,{className:"h-5 w-5"}),"Export Usage Reports"]})}),e.jsx(S,{children:e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Download detailed usage reports with daily consumption data, costs, and trends."}),e.jsxs("div",{className:"flex flex-wrap gap-4",children:[e.jsxs(M,{variant:"outline",onClick:me,className:"flex items-center gap-2",children:[e.jsx(oe,{className:"h-4 w-4"}),"Export as PDF"]}),e.jsxs(M,{variant:"outline",onClick:ue,className:"flex items-center gap-2",children:[e.jsx(L,{className:"h-4 w-4"}),"Export Detailed PDF"]})]}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Reports include: Daily usage data, cost breakdown, consumption trends, and efficiency metrics"})]})})]}),!T&&!b&&e.jsxs(A,{id:"current-bill",className:"scroll-mt-24",children:[e.jsx(C,{children:e.jsxs(U,{children:["Current Bill (",Q," ",E,")"]})}),e.jsx(S,{children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("span",{className:"text-muted-foreground",children:["Water Usage (",(Number((a==null?void 0:a.water_usage)||0)/1e3).toFixed(2)," kL)"]}),e.jsx("span",{className:"font-semibold",children:x(Number((a==null?void 0:a.water_cost)||0))})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("span",{className:"text-muted-foreground",children:["Electricity Usage (",Number((a==null?void 0:a.electricity_usage)||0).toFixed(0)," kWh)"]}),e.jsx("span",{className:"font-semibold",children:x(Number((a==null?void 0:a.electricity_cost)||0))})]}),e.jsxs("div",{className:"flex justify-between items-center border-t pt-4",children:[e.jsx("span",{className:"font-semibold",children:"Total Amount"}),e.jsx("span",{className:"font-bold text-lg",children:x(Number((a==null?void 0:a.total_amount)||0))})]}),e.jsx("div",{className:"flex justify-end",children:e.jsxs(M,{variant:"outline",onClick:()=>B(`${Q} ${E}`),children:[e.jsx(L,{className:"mr-2 h-4 w-4"}),"Download Bill"]})})]})})]}),!T&&!b&&e.jsxs(A,{id:"history",className:"scroll-mt-24",children:[e.jsx(C,{children:e.jsx(U,{children:"Billing History"})}),e.jsx(S,{children:e.jsxs("div",{className:"space-y-4",children:[N.slice(1).map(l=>{const t=new Date(l.period_start),g=`${t.toLocaleString("default",{month:"long"})} ${t.getFullYear()}`;return e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:g}),e.jsx("p",{className:"text-sm text-muted-foreground capitalize",children:l.status})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("span",{children:x(Number(l.total_amount||0))}),e.jsx(M,{variant:"outline",size:"icon",onClick:()=>B(g),children:e.jsx(L,{className:"h-4 w-4"})})]})]},l.id)}),!N.slice(1).length&&e.jsx("div",{className:"text-sm text-muted-foreground",children:"No past bills yet."})]})})]})]})})]})})};export{Ae as default};
